name: CI/CD Kubernetes Deployment (Secure GCP Access - FINAL SSH TUNNEL)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}
  SA_SECRET_NAME: gcp-sa-secret
  VM_IP: 34.79.223.105
  VM_USER: mouna_gcp
  API_PORT: 40675

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Set Lowercase Owner Name
      id: lowercase_owner
      run: |
        echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.IMAGE_OWNER }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Push post-consumer image
      uses: docker/build-push-action@v5
      with:
        context: ./post_consumer
        file: ./post_consumer/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ steps.lowercase_owner.outputs.owner_lc }}/post-consumer:${{ github.sha }}

    - name: Build and Push post-pusher image
      uses: docker/build-push-action@v5
      with:
        context: ./post_pusher
        file: ./post_pusher/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ steps.lowercase_owner.outputs.owner_lc }}/post-pusher-kafka:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Set Lowercase Owner Name for Deployment
      id: lowercase_owner_deploy
      run: |
        echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Configure Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Install yq (YAML Processor)
      run: |
        wget https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -O /usr/local/bin/yq
        chmod +x /usr/local/bin/yq

    - name: Set Kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config

    - name: ðŸ” Setup SSH Tunnel to VM API
      env:
        SSH_KEY: ${{ secrets.GCP_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.VM_IP }} >> ~/.ssh/known_hosts
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -N -L ${{ env.API_PORT }}:127.0.0.1:${{ env.API_PORT }} ${{ env.VM_USER }}@${{ env.VM_IP }} &
        sleep 5

    - name: Wait for Kubernetes API
      run: kubectl wait --for=condition=ready node --all --timeout=300s

    - name: Create/Update Secret for Service Account (GCP)
      run: |
        kubectl create secret generic ${{ env.SA_SECRET_NAME }} \
          --from-literal=service-account.json='${{ secrets.SA_JSON }}' \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: ðŸ”‘ Create GHCR Image Pull Secret
      run: |
        kubectl create secret docker-registry ghcr-pull-secret \
          --docker-server=ghcr.io \
          --docker-username=${{ github.repository_owner }} \
          --docker-password=${{ secrets.GITHUB_TOKEN }} \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: Patch Deployment Manifests
      run: |
        SHA_TAG=${{ github.sha }}
        OWNER_LC="${{ steps.lowercase_owner_deploy.outputs.owner_lc }}"
        REGISTRY_PATH="ghcr.io/$OWNER_LC"
        SA_SECRET="${{ env.SA_SECRET_NAME }}"

        CONSUMER_DEPLOYMENT="post_consumer/deployment.yaml"
        PUSHER_DEPLOYMENT="post_pusher/deployment.yaml"
        UI_DEPLOYMENT="ui/deployment.yaml"
        MOUNT_PATH='/service-account.json'

        patch_sa() {
          FILE=$1
          CONTAINER=$2

          # Update image and pull policy
          yq e -i '.spec.template.spec.containers[] |= select(.name=="'"$CONTAINER"'").image = "'"$REGISTRY_PATH/$CONTAINER:$SHA_TAG"'" |
                  select(.name=="'"$CONTAINER"'").imagePullPolicy = "IfNotPresent"' $FILE

          # Add volume mount for GCP secret
          yq e -i '.spec.template.spec.containers[] |= select(.name=="'"$CONTAINER"'").volumeMounts += [{"name":"gcp-sa-volume","mountPath":"'"$MOUNT_PATH"'","subPath":"service-account.json"}]' $FILE

          # Add volume definition
          yq e -i '.spec.template.spec.volumes += [{"name":"gcp-sa-volume","secret":{"secretName":"'"$SA_SECRET"'"}}]' $FILE

          # Add imagePullSecrets
          yq e -i '.spec.template.spec.imagePullSecrets += [{"name":"ghcr-pull-secret"}]' $FILE
        }

        patch_sa "$CONSUMER_DEPLOYMENT" "post-consumer"
        patch_sa "$PUSHER_DEPLOYMENT" "post-pusher-kafka"

        # Patch Kafka UI ConfigMap volume
        yq e -i '.spec.template.spec.containers[] |= select(.name=="kafka-ui").volumeMounts += [{"name":"config-volume","mountPath":"/etc/kafkaui/dynamic_config.yaml","subPath":"dynamic_config.yaml"}]' $UI_DEPLOYMENT
        yq e -i '.spec.template.spec.volumes += [{"name":"config-volume","configMap":{"name":"kafka-ui-config"}}]' $UI_DEPLOYMENT

    - name: Deploy to Kubernetes
      run: |
        echo "--- Applying Kafka Infrastructure ---"
        kubectl apply -f kafka/configmap.yaml
        kubectl apply -f kafka/service.yaml
        kubectl apply -f kafka/deployment.yaml

        echo "--- Applying Kafka UI ---"
        kubectl apply -f ui/service.yaml
        kubectl apply -f ui/deployment.yaml

        echo "--- Applying Application Deployments ---"
        kubectl apply -f post_consumer/deployment.yaml
        kubectl apply -f post_pusher/deployment.yaml

        echo "Deployment complete."
