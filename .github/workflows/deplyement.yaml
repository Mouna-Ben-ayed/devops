name: CI/CD Deployment - Self-Hosted VM (No Registry)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet de lancer manuellement

env:
  # Tags locaux pour les images (pas de ghcr.io)
  CONSUMER_IMAGE: post-consumer:latest
  PUSHER_IMAGE: post-pusher-kafka:latest
  SA_SECRET_NAME: gcp-sa-secret
  
jobs:
  build-and-deploy-on-vm:
    runs-on: 
      # Cible votre runner spÃ©cifique sur la VM GCP
      - self-hosted
      - gcp-vm-runner 
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # --- 1. Construction des Images (sur la VM) ---
      
      # Build & Load Post-Consumer Image
      - name: ðŸ”¨ Build and Load Consumer Image
        uses: docker/build-push-action@v5
        with:
          context: ./post_consumer
          file: ./post_consumer/Dockerfile
          push: false 
          load: true # Charge l'image dans le dÃ©mon Docker de la VM
          tags: ${{ env.CONSUMER_IMAGE }}
          
      # Build & Load Post-Pusher Image
      - name: ðŸ”¨ Build and Load Pusher Image
        uses: docker/build-push-action@v5
        with:
          context: ./post_pusher
          file: ./post_pusher/Dockerfile
          push: false
          load: true # Charge l'image dans le dÃ©mon Docker de la VM
          tags: ${{ env.PUSHER_IMAGE }}

      # --- 2. Configuration & Secrets Kubernetes ---

      # Configure Kubectl (S'assure que kubectl est utilisable sur la VM)
      - name: Configure Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      # CrÃ©ation/Mise Ã  jour du Secret pour le Compte de Service GCP (Remplace kubectl create secret)
      - name: ðŸ”‘ Create/Update Secret for Service Account (GCP)
        uses: azure/k8s-create-secret@v4
        with:
          namespace: default
          secret-type: 'generic'
          secret-name: ${{ env.SA_SECRET_NAME }}
          string-data:  |
            service-account.json=${{ secrets.SA_JSON }}

      # --- 3. DÃ©ploiement Kubernetes (sur la VM) ---
      
      # DÃ©ploiement de l'Infrastructure Kafka
      - name: ðŸš€ Deploy Kafka Infrastructure
        uses: azure/k8s-deploy@v4
        with:
          namespace: default
          manifests: |
            kafka/configmap.yaml
            kafka/service.yaml
            kafka/deployment.yaml

      # DÃ©ploiement de l'Interface Utilisateur (UI)
      - name: ðŸš€ Deploy Kafka UI
        uses: azure/k8s-deploy@v4
        with:
          namespace: default
          manifests: |
            ui/service.yaml
            ui/deployment.yaml

      # DÃ©ploiement des Applications (Consumer & Pusher)
      # L'action k8s-deploy met automatiquement Ã  jour les tags des images 
      # dans les manifests avant l'application (Remplace yq/patch)
      - name: ðŸš€ Deploy Application Deployments
        uses: azure/k8s-deploy@v4
        with:
          namespace: default
          manifests: |
            post_consumer/deployment.yaml
            post_pusher/deployment.yaml
          # Ces images sont utilisÃ©es pour patcher le manifeste avant l'application
          images: |
            ${{ env.CONSUMER_IMAGE }}
            ${{ env.PUSHER_IMAGE }}
            
      - name: âœ… Deployment Complete
        run: echo "Le dÃ©ploiement est terminÃ©. Les images sont locales sur la VM."